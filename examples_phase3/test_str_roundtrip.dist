// String integrity roundtrip test (headless).
// Verifies Disturb strings are NUL-terminated and correct when passed via FFI.

shim_path = read("disturb_bindings/shim_path_phase3.bin");
if (shim_path == null) {
  shim_path = "./libraylib_disturb_phase3.so";
}

lib = ffi.load(shim_path,
  "i32 rl_str_len(char*)",
  "i32 rl_str_hash(char*)",
  "i32 rl_str_check_nul(char*, i32)"
);

failed = 0;
check = (name, cond){
  if (cond) {
    println("PASS " + name);
    return 0;
  }
  else {
    println("FAIL " + name);
    return 1;
  }
};

// Test 1: empty string
failed = failed + check("empty_str_len", lib.rl_str_len("") == 0);
failed = failed + check("empty_str_nul", lib.rl_str_check_nul("", 4096) == 1);

// Test 2: simple ASCII string
failed = failed + check("hello_len", lib.rl_str_len("hello") == 5);
failed = failed + check("hello_nul", lib.rl_str_check_nul("hello", 4096) == 1);

// Test 3: longer string
test_str = "The quick brown fox jumps over the lazy dog";
failed = failed + check("long_str_len", lib.rl_str_len(test_str) == 43);
failed = failed + check("long_str_nul", lib.rl_str_check_nul(test_str, 4096) == 1);

// Test 4: concatenated string (tests the append path NUL-termination)
a = "foo";
b = "bar";
ab = a + b;
failed = failed + check("concat_len", lib.rl_str_len(ab) == 6);
failed = failed + check("concat_nul", lib.rl_str_check_nul(ab, 4096) == 1);

// Test 5: single character string
failed = failed + check("single_char_len", lib.rl_str_len("A") == 1);
failed = failed + check("single_char_nul", lib.rl_str_check_nul("A", 4096) == 1);

// Test 6: string with spaces
s = "hello world";
failed = failed + check("spaces_len", lib.rl_str_len(s) == 11);
failed = failed + check("spaces_nul", lib.rl_str_check_nul(s, 4096) == 1);

// Test 7: repeated concatenation (stress test for append path)
r = "";
i = 0;
while (i < 10) {
  r = r + "x";
  i = i + 1;
}
failed = failed + check("repeated_concat_len", lib.rl_str_len(r) == 10);
failed = failed + check("repeated_concat_nul", lib.rl_str_check_nul(r, 4096) == 1);

// Test 8: hash consistency (same string â†’ same hash, proves NUL at right place)
h1 = lib.rl_str_hash("hello");
h2 = lib.rl_str_hash("hello");
failed = failed + check("hash_consistency", h1 == h2);

// Test 9: hash differs for different strings
h3 = lib.rl_str_hash("world");
failed = failed + check("hash_differs", h1 != h3);

// Test 10: hash of concat matches hash of literal
h_concat = lib.rl_str_hash("foo" + "bar");
h_literal = lib.rl_str_hash("foobar");
failed = failed + check("hash_concat_eq_literal", h_concat == h_literal);

// Test 11: window title string (common pattern in raylib examples)
title = "raylib core: basic window";
failed = failed + check("title_len", lib.rl_str_len(title) == 25);
failed = failed + check("title_nul", lib.rl_str_check_nul(title, 4096) == 1);

// Test 12: DrawText-like string
msg = "Use arrow keys";
failed = failed + check("msg_len", lib.rl_str_len(msg) == 14);
failed = failed + check("msg_nul", lib.rl_str_check_nul(msg, 4096) == 1);

if (failed == 0) {
  println("PASS string roundtrip: all tests passed");
}
else {
  println("FAIL string roundtrip: " + failed + " failure(s)");
  system("kill -TERM $PPID");
}
