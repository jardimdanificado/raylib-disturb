// Phase 9 pointer roundtrip validation.
// Ensures 64-bit pointer values preserve all bits across Disturb FFI.

eval(read("generated/raylib_ffi_phase3.dist"));

fail = (msg){
  println("FAIL ptr_roundtrip: " + msg);
  system("kill -TERM $PPID");
};

// 1) Raw allocation handle roundtrip.
p = raylib_phase3.rl2_MemAlloc(64);
if (p == 0) { fail("MemAlloc returned NULL"); }

p_id = raylib_phase3.rl_ptr_identity(p);
if (raylib_phase3.rl_ptr_equal(p, p_id) != 1) {
  fail("identity(handle) mismatch");
}

h1 = raylib_phase3.rl_ptr_hash(p);
h2 = raylib_phase3.rl_ptr_hash(p_id);
if (h1 != h2) {
  fail("hash(handle) mismatch");
}

raylib_phase3.rl2_MemFree(p_id);

// 2) Real raylib handle roundtrip (Image by-value resource wrapped as void*).
img = raylib_phase3.rl2_GenImageColor(4, 4, 0x11223344);
if (img == 0) { fail("GenImageColor returned NULL handle"); }

img_id = raylib_phase3.rl_ptr_identity(img);
if (raylib_phase3.rl_ptr_equal(img, img_id) != 1) {
  fail("identity(image handle) mismatch");
}

if (raylib_phase3.rl2_IsImageValid(img_id) != 1) {
  fail("IsImageValid(image handle) failed");
}

pix = [0];
pix.size = 1;
ok = raylib_phase3.rl2_GetImageColor(img_id, 0, 0, pix, pix.size);
if (ok != 1) {
  fail("GetImageColor failed");
}

raylib_phase3.rl2_UnloadImage(img_id);
println("PASS ptr_roundtrip");
