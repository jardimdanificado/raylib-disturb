// Phase 6 conformance runner.
// Returns non-zero on FAIL by terminating parent Disturb process.

shim_path = read("disturb_bindings/shim_path_phase3.bin");
if (shim_path == null) {
  shim_path = "./libraylib_disturb_phase3.so";
}

raylib_phase3 = ffi.load(shim_path,
  "i32 rl2_GetCodepointCount(char*)",
  "i32 rl2_FileExists(char*)",
  "i32 rl2_GetRandomValue(i32, i32)",
  "i32 rl2_MeasureText(char*, i32)",
  "i32 rl2_GetCodepoint(char*, int[], i32)",
  "char* rl2_LoadUTF8(int[], i32)",
  "i32 rl2_GetCameraMatrix2D(void*, float[], i32)",
  "i32 rl2_CheckCollisionBoxes(float[], i32, float[], i32)",
  "void* rl2_InitWindow(i32, i32, char*)",
  "void* rl2_SetTargetFPS(i32)",
  "i32 rl2_WindowShouldClose()",
  "void* rl2_BeginDrawing()",
  "void* rl2_ClearBackground(i32)",
  "void* rl2_EndDrawing()",
  "void* rl2_CloseWindow()",
  "void* rl2_InitAudioDevice()",
  "i32 rl2_IsAudioDeviceReady()",
  "void* rl2_CloseAudioDevice()"
);

failed = 0;
check = (name, cond){
  if (cond) {
    println("PASS " + name);
    return 0;
  }
  else {
    println("FAIL " + name);
    return 1;
  }
};

fail_exit = (){
  // Kill Disturb parent process from shell child => non-zero exit status.
  system("kill -TERM $PPID");
};

// Pure checks
failed = failed + check("GetCodepointCount", raylib_phase3.rl2_GetCodepointCount("phase6") == 6);
failed = failed + check("FileExists(.gitignore)", raylib_phase3.rl2_FileExists(".gitignore") == 1);
failed = failed + check("GetRandomValue fixed", raylib_phase3.rl2_GetRandomValue(11, 11) == 11);
failed = failed + check("MeasureText non-negative", raylib_phase3.rl2_MeasureText("phase6", 20) >= 0);

cp_size = [0];
cp_size.size = 1;
cp = raylib_phase3.rl2_GetCodepoint("A", cp_size, cp_size.size);
failed = failed + check("GetCodepoint value", cp == 65);
failed = failed + check("GetCodepoint out", cp_size[0] == 1);

codepoints = [65];
codepoints.size = 1;
utf8 = raylib_phase3.rl2_LoadUTF8(codepoints, 1);
failed = failed + check("LoadUTF8", utf8 == "A");

mat = [0.0];
mat.size = 16;
mat_ok = raylib_phase3.rl2_GetCameraMatrix2D(null, mat, mat.size);
failed = failed + check("GetCameraMatrix2D status", mat_ok == 1);
failed = failed + check("GetCameraMatrix2D finite", mat[0] == mat[0] && mat[15] == mat[15]);

box_a = [0.0]; box_a.size = 6;
box_a[0] = 0; box_a[1] = 0; box_a[2] = 0;
box_a[3] = 10; box_a[4] = 10; box_a[5] = 10;
box_b = [0.0]; box_b.size = 6;
box_b[0] = 5; box_b[1] = 5; box_b[2] = 5;
box_b[3] = 15; box_b[4] = 15; box_b[5] = 15;
failed = failed + check("CheckCollisionBoxes", raylib_phase3.rl2_CheckCollisionBoxes(box_a, box_a.size, box_b, box_b.size) == 1);

// Optional window checks
if (system("test -n \"$DISTURB_HEADLESS\"") == 0 || system("test -n \"$DISPLAY\"") != 0 || system("xdpyinfo >/dev/null 2>&1") != 0) {
  println("SKIP window checks (headless environment)");
}
else {
  raylib_phase3.rl2_InitWindow(200, 120, "phase6 conformance");
  raylib_phase3.rl2_SetTargetFPS(60);
  frames = 0;
  while (raylib_phase3.rl2_WindowShouldClose() == 0 && frames < 30) {
    frames = frames + 1;
    raylib_phase3.rl2_BeginDrawing();
    raylib_phase3.rl2_ClearBackground(0xF5F5F5FF);
    raylib_phase3.rl2_EndDrawing();
  }
  raylib_phase3.rl2_CloseWindow();
  failed = failed + check("Window loop", frames > 0);
}

// Optional audio checks
raylib_phase3.rl2_InitAudioDevice();
audio_ready = raylib_phase3.rl2_IsAudioDeviceReady();
if (audio_ready != 0) {
  failed = failed + check("Audio ready", audio_ready == 1);
}
else {
  println("SKIP audio checks (no playback device)");
}
raylib_phase3.rl2_CloseAudioDevice();

if (failed == 0) {
  println("PASS phase6 conformance");
}
else {
  println("FAIL phase6 conformance: " + failed + " failure(s)");
  fail_exit();
}
