// Public Disturb API for raylib (Phase 10 ergonomic layer).
// Keeps low-level FFI private and exposes user-facing wrappers.

eval(read("generated/raylib_ffi_phase3.dist"));

_rl = raylib_phase3;

Color = (r, g, b, a){
  return ((r & 255) << 24) | ((g & 255) << 16) | ((b & 255) << 8) | (a & 255);
};

COLOR_WHITE     = Color(255, 255, 255, 255);
COLOR_BLACK     = Color(0, 0, 0, 255);
COLOR_RAYWHITE  = Color(245, 245, 245, 255);
COLOR_LIGHTGRAY = Color(200, 200, 200, 255);
COLOR_GRAY      = Color(130, 130, 130, 255);
COLOR_DARKGRAY  = Color(80, 80, 80, 255);
COLOR_RED       = Color(230, 41, 55, 255);
COLOR_MAROON    = Color(190, 33, 55, 255);
COLOR_GREEN     = Color(0, 228, 48, 255);
COLOR_BLUE      = Color(0, 121, 241, 255);
COLOR_DARKBLUE  = Color(0, 82, 172, 255);
COLOR_SKYBLUE   = Color(102, 191, 255, 255);
COLOR_YELLOW    = Color(253, 249, 0, 255);
COLOR_ORANGE    = Color(255, 161, 0, 255);
COLOR_PURPLE    = Color(200, 122, 255, 255);

KEY_ESCAPE = 256;
KEY_SPACE  = 32;
KEY_LEFT   = 263;
KEY_RIGHT  = 262;
KEY_UP     = 265;
KEY_DOWN   = 264;
KEY_A      = 65;
KEY_D      = 68;
KEY_S      = 83;
KEY_W      = 87;

MOUSE_BUTTON_LEFT = 0;

hasDisplay = (){
  if (system("test -n \"$DISTURB_HEADLESS\"") == 0) { return 0; }
  if (system("test -n \"$DISPLAY\"") != 0) { return 0; }
  if (system("xdpyinfo >/dev/null 2>&1") != 0) { return 0; }
  return 1;
};

hasAsset = (path){
  return system("test -f " + path) == 0;
};

initWindow = (w, h, title){
  _rl.rl2_InitWindow(w, h, title);
};

closeWindow = (){ _rl.rl2_CloseWindow(); };
windowShouldClose = (){ return _rl.rl2_WindowShouldClose(); };
setTargetFPS = (fps){ _rl.rl2_SetTargetFPS(fps); };
getFPS = (){ return _rl.rl2_GetFPS(); };
getFrameTime = (){ return _rl.rl2_GetFrameTime(); };
getTime = (){ return _rl.rl2_GetTime(); };
waitTime = (sec){ _rl.rl2_WaitTime(sec); };

beginDrawing = (){ _rl.rl2_BeginDrawing(); };
endDrawing = (){ _rl.rl2_EndDrawing(); };
clearBackground = (color){ _rl.rl2_ClearBackground(color); };

drawText = (text, x, y, size, color){ _rl.rl2_DrawText(text, x, y, size, color); };
drawRectangle = (x, y, w, h, color){ _rl.rl2_DrawRectangle(x, y, w, h, color); };
drawRectangleLines = (x, y, w, h, color){ _rl.rl2_DrawRectangleLines(x, y, w, h, color); };
drawCircle = (x, y, radius, color){ _rl.rl2_DrawCircle(x, y, radius, color); };
drawLine = (x1, y1, x2, y2, color){ _rl.rl2_DrawLine(x1, y1, x2, y2, color); };
drawFPS = (x, y){ _rl.rl2_DrawFPS(x, y); };

isKeyDown = (key){ return _rl.rl2_IsKeyDown(key); };
isKeyPressed = (key){ return _rl.rl2_IsKeyPressed(key); };
getKeyPressed = (){ return _rl.rl2_GetKeyPressed(); };
getMouseWheelMove = (){ return _rl.rl2_GetMouseWheelMove(); };

getMousePosition = (){
  p = [0.0];
  p.size = 2;
  ok = _rl.rl2_GetMousePosition(p, p.size);
  if (ok != 1) {
    return { x = 0.0, y = 0.0, ok = 0 };
  }
  return { x = p[0], y = p[1], ok = 1 };
};

measureText = (text, size){ return _rl.rl2_MeasureText(text, size); };

beginMode2D = (camera){
  if (camera == null) { _rl.rl2_BeginMode2D(0); }
  else { _rl.rl2_BeginMode2D(camera); }
};

endMode2D = (){ _rl.rl2_EndMode2D(); };

getCameraMatrix2D = (camera){
  out = [0.0];
  out.size = 16;
  ok = _rl.rl2_GetCameraMatrix2D(camera, out, out.size);
  if (ok != 1) {
    return { ok = 0 };
  }
  return {
    ok = 1,
    m0 = out[0], m1 = out[1], m2 = out[2], m3 = out[3],
    m4 = out[4], m5 = out[5], m6 = out[6], m7 = out[7],
    m8 = out[8], m9 = out[9], m10 = out[10], m11 = out[11],
    m12 = out[12], m13 = out[13], m14 = out[14], m15 = out[15]
  };
};

_makeTexture = (handle){
  return {
    ptr = handle,
    draw = (x, y, tint){
      local_tint = tint;
      if (local_tint == null) { local_tint = COLOR_WHITE; }
      _rl.rl2_DrawTexture(this.ptr, x, y, local_tint);
    },
    drawEx = (x, y, rotation, scale, tint){
      local_tint = tint;
      if (local_tint == null) { local_tint = COLOR_WHITE; }
      _rl.rl2_DrawTextureEx(this.ptr, x, y, rotation, scale, local_tint);
    },
    drawRec = (sx, sy, sw, sh, dx, dy, tint){
      local_tint = tint;
      if (local_tint == null) { local_tint = COLOR_WHITE; }
      _rl.rl2_DrawTextureRec(this.ptr, sx, sy, sw, sh, dx, dy, local_tint);
    },
    unload = (){
      if (this.ptr != null && this.ptr != 0) {
        _rl.rl2_UnloadTexture(this.ptr);
        this.ptr = 0;
      }
    }
  };
};

loadTexture = (path){
  return _makeTexture(_rl.rl2_LoadTexture(path));
};

_makeImage = (handle){
  return {
    ptr = handle,
    isValid = (){ return _rl.rl2_IsImageValid(this.ptr); },
    clear = (color){ _rl.rl2_ImageClearBackground(this.ptr, color); },
    drawRectangle = (x, y, w, h, color){ _rl.rl2_ImageDrawRectangle(this.ptr, x, y, w, h, color); },
    drawCircle = (x, y, r, color){ _rl.rl2_ImageDrawCircle(this.ptr, x, y, r, color); },
    drawLine = (x1, y1, x2, y2, color){ _rl.rl2_ImageDrawLine(this.ptr, x1, y1, x2, y2, color); },
    drawText = (text, x, y, size, color){ _rl.rl2_ImageDrawText(this.ptr, text, x, y, size, color); },
    getPixel = (x, y){
      out = [0];
      out.size = 1;
      ok = _rl.rl2_GetImageColor(this.ptr, x, y, out, out.size);
      if (ok != 1) { return null; }
      return out[0];
    },
    unload = (){
      if (this.ptr != null && this.ptr != 0) {
        _rl.rl2_UnloadImage(this.ptr);
        this.ptr = 0;
      }
    }
  };
};

genImageColor = (w, h, color){
  return _makeImage(_rl.rl2_GenImageColor(w, h, color));
};

beginOffscreen = (w, h, bgColor){
  img = genImageColor(w, h, bgColor);
  return img;
};

readPixel = (img, x, y){
  return img.getPixel(x, y);
};

countNonBackground = (img, w, h, bg){
  c = 0;
  y = 0;
  while (y < h) {
    x = 0;
    while (x < w) {
      p = img.getPixel(x, y);
      if (p != null && p != bg) { c = c + 1; }
      x = x + 1;
    }
    y = y + 1;
  }
  return c;
};

assertPixelEquals = (img, x, y, expected){
  p = img.getPixel(x, y);
  if (p == expected) { return 1; }
  return 0;
};

assertPixelNotEquals = (img, x, y, unexpected){
  p = img.getPixel(x, y);
  if (p != null && p != unexpected) { return 1; }
  return 0;
};
